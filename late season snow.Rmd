---
title: "late season snow"
author: "Wyatt Reis"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(snotelr)
library(mapview)
library(lubridate)
library(plotly)
library(sf)
```

```{r, eval=FALSE, echo=FALSE}
## Download SNOTEL

# # Test SNOTEL Data Download/Save
#snotel_test <- snotel_download(site_id = c(551, 301, 901), internal = TRUE)
# 
# save(snotel_test, file = "data/snotel_test.RData")

# 
# write.csv(snotel_551, "data/snotel_551.csv")
# 
# # Colorado SNOTEL Data
# site_meta_data_co <- snotel_info() %>%
#   filter(state == "CO")
# # 
# mapview(site_meta_data_co, ycol = "latitude", xcol = "longitude", crs = 4326, grid = FALSE)
# 
# co_snow_data <- snotel_download(site_id = site_meta_data_co$site_id, internal = TRUE)
# 
# write.csv(co_snow_data, "data/co_snotel.csv")
# 
# # Contiguous US Data 
# site_meta_data_cont <- snotel_info() %>%
#   filter(state != "AK")
# 
# mapview(site_meta_data_cont, ycol = "latitude", xcol = "longitude", crs = 4326, grid = FALSE)
# 
# cont_snow_data <- snotel_download(site = site_meta_data_cont$site_id, internal = TRUE)
# 
# write.csv(cont_snow_data, "data/snotel_cont.csv")
```

```{r}
# Import data from .RData
load("data/cont_snotel.RData")

# Import seasonal snow zone polygons
#SSZ <- st_read('data/MODIS_Snow_Zones/SSZ_0cc.shp')
PSZ <- st_read('data/MODIS_Snow_Zones/PSZ_0cc.shp')
eco_L3 <- st_read('data/eco_regions/us_eco_l3.shp')
```

```{r}
# Group sites by site_id
cont_snotel_site <- cont_snow_data %>%
  group_by(site_id, site_name, state, latitude, longitude, elev) %>%
  summarise()

# transform files to CRS:4326
snotel_sites <- st_as_sf(cont_snotel_site, coords = c('longitude', 'latitude'), crs = 4326)
PSZ_4326 <- st_transform(PSZ, crs = 4326)
eco_L3_4326 <- st_transform(eco_L3, crs = 4326)

# clip SNOTEL Sites to PSZ
sf::sf_use_s2(FALSE)
PSZ_snotel_sites = st_intersection(PSZ_4326, snotel_sites)

#Assign Eco Region Data
PSZ_snotel_sites <- st_join(PSZ_snotel_sites, left = FALSE, eco_L3_4326[c("US_L3NAME", "US_L3CODE", "L3_KEY")])

#Create Map of SNOTEL Sites based on persistent snow zone (PSZ)
mapview(snotel_sites, col.regions = "red") +
  mapview(PSZ_snotel_sites, col.regions = "blue")
```

```{r, eval=FALSE, echo=FALSE}
# # Filter all SNOTEL to PSZ SNOTEL Sites Only
# PSZ_cont_snotel <- cont_snow_data[cont_snow_data$site_id %in% PSZ_snotel_sites$site_id,]
# 
# # Merge the eco regions with the rest of the data
# PSZ_cont_snotel <- merge(PSZ_cont_snotel, PSZ_snotel_sites, by = c("site_id", "site_name", "state", "elev"))
# 
# # Save DF
# save(PSZ_cont_snotel, file = "data/PSZ_cont_snotel.RData")
```

```{r}
# Import data from .RData
load("data/PSZ_cont_snotel.RData")

# PSZ SNOTEL Sites, Calculate spring days with new SWE and new SWE depth 
# filter by date (March 1st - 60/61, March 15th - 74/75, April 1st - 91/92, April 15th - 105/106, August 1st - 243/244)
start_year = 1979
start_day = 91
end_day = 243

PSZ_cont_snotel_spring <- PSZ_cont_snotel %>%
  mutate(date = as.POSIXct(date, format = "%Y-%m-%d"),yday = yday(date), year = year(date)) %>%
  mutate(newSWE = ifelse(snow_water_equivalent>lag(snow_water_equivalent), snow_water_equivalent-lag(snow_water_equivalent), 0)) %>%
  filter(state != "SD", year >= start_year, ifelse(leap_year(year) == FALSE, yday >= start_day & yday <= end_day, 
                                                   yday >= start_day+1 & yday <= end_day+1)) %>% 
  select(-c("X", "network", "description", "start", "end", "GRIDCODE", "Area"))

# Determine number of days with increased SWE per spring at each site in the PSZ (YEARLY)
PSZ_cont_snotel_site_yr <- PSZ_cont_snotel_spring %>%
  group_by(site_id, site_name, state, year, latitude, longitude, elev, US_L3CODE, US_L3NAME, L3_KEY) %>%
  summarise(newSWE_days = sum(newSWE>0, na.rm = TRUE), 
            newSWE = sum(newSWE, na.rm = TRUE))

# Determine average number of days with increased SWE per spring at each site in the PSZ (SITE)
PSZ_cont_snotel_site <- PSZ_cont_snotel_site_yr %>%
  group_by(site_id, site_name, state, latitude, longitude, elev, US_L3CODE, US_L3NAME, L3_KEY) %>%
  summarise(mean_spring_days = mean(newSWE_days), med_spring_days = median(newSWE_days),
            mean_newSWE = mean(newSWE), med_newSWE = median(newSWE))

# View data
mapview(PSZ_cont_snotel_site, ycol = "latitude", xcol = "longitude", zcol = "med_spring_days",
        layer.name = "AVG Sping Days (PSZ Sites)" , crs = 4326, grid = FALSE) +
  mapview(eco_L3_4326, zcol = "L3_KEY")
```

```{r, fig.width=12,fig.height=7}
# Create a boxplot of increased SWE for all sites based on ecoregion
PSZ_spring_snow_days <- ggplot(PSZ_cont_snotel_site_yr, aes(x = US_L3CODE, y= newSWE_days, color = L3_KEY)) +
  geom_boxplot()+
  ggtitle("Days of increased SWE at PSZ sites (1978-2022)")
ggplotly(PSZ_spring_snow_days)
```

```{r}
# summary(cont_snotel_site_yr$elev)
# hist(cont_snotel_site_yr$elev)
# 
# cont_snotel_site_yr <- cont_snotel_site_yr %>% 
#   mutate(elev_band = ifelse(elev >= 2000, "High (>=2500)", 
#                             ifelse(elev < 2000 & elev >= 1200, "Mid (1500-2500)", "Low (<= 1500)")))
```

```{r}
# Elevation vs new snow count
elev_newsnow <- plot_ly(PSZ_cont_snotel_site, x = ~med_spring_days, y = ~elev, color = ~US_L3NAME, type = 'scatter', mode = 'markers', 
                        hoverinfo = 'text',
                        text = ~paste('</br> median new days: ', med_spring_days,
                                      '</br> elev: ', elev,
                                      '</br> site_name: ', site_name,
                                      '</br> ecoregion: ', US_L3NAME,
                                      '</br> state: ', state)) %>% 
  layout(title = "Average Increased SWE Days by Elevation")
 
elev_newsnow

elev_newsnow_depth <- plot_ly(PSZ_cont_snotel_site, x = ~med_newSWE, y = ~elev, color = ~US_L3NAME, type = 'scatter', mode = 'markers', 
                        hoverinfo = 'text',
                        text = ~paste('</br> median new SWE (mm): ', med_newSWE,
                                      '</br> elev: ', elev,
                                      '</br> site_name: ', site_name,
                                      '</br> ecoregion: ', US_L3NAME,
                                      '</br> state: ', state)) %>% 
  layout(title = "Average Increased SWE Depth (mm) by Elevation")
 
elev_newsnow_depth
```