---
title: "late season snow"
author: "Wyatt Reis"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(snotelr)
library(mapview)
library(lubridate)
library(plotly)
library(sf)
```

```{r, eval=FALSE, echo=FALSE}
## Download SNOTEL

# # Test SNOTEL Data Download/Save
#snotel_test <- snotel_download(site_id = c(551, 301, 901), internal = TRUE)
# 
# save(snotel_test, file = "data/snotel_test.RData")

# 
# write.csv(snotel_551, "data/snotel_551.csv")
# 
# # Colorado SNOTEL Data
# site_meta_data_co <- snotel_info() %>%
#   filter(state == "CO")
# # 
# mapview(site_meta_data_co, ycol = "latitude", xcol = "longitude", crs = 4326, grid = FALSE)
# 
# co_snow_data <- snotel_download(site_id = site_meta_data_co$site_id, internal = TRUE)
# 
# write.csv(co_snow_data, "data/co_snotel.csv")
# 
# # Contiguous US Data 
# site_meta_data_cont <- snotel_info() %>%
#   filter(state != "AK")
# 
# mapview(site_meta_data_cont, ycol = "latitude", xcol = "longitude", crs = 4326, grid = FALSE)
# 
# cont_snow_data <- snotel_download(site = site_meta_data_cont$site_id, internal = TRUE)
# 
# write.csv(cont_snow_data, "data/snotel_cont.csv")
```

```{r}
## Import data from .RData
load("data/cont_snotel.RData")

# Import seasonal snow zone polygons
SSZ <- st_read('data/MODIS_Snow_Zones/SSZ_0cc.shp')
PSZ <- st_read('data/MODIS_Snow_Zones/PSZ_0cc.shp')
```

```{r}
# Group sites by site_id
cont_snotel_site <- cont_snow_data %>%
  group_by(site_id, site_name, state, latitude, longitude, elev) %>%
  summarise()

# transform files to CRS:4326
snotel_sites <- st_as_sf(cont_snotel_site, coords = c('longitude', 'latitude'), crs = 4326) #fix before next run
PSZ_4326 <- st_transform(PSZ, crs = 4326)

# clip SNOTEL Sites to PSZ
sf::sf_use_s2(FALSE)
PSZ_snotel_sites = st_intersection(PSZ_4326, snotel_sites)

mapview(PSZ_snotel_sites) + 
  mapview(PSZ_4326)
```

```{r}
# Filter all SNOTEL to PSZ SNOTEL Sites Only
PSZ_cont_snotel <- cont_snow_data[cont_snow_data$site_id %in% PSZ_snotel_sites$site_id,]

# PSZ SNOTEL Site, Calculate spring days with new SWE and new SWE depth 
PSZ_cont_snotel_spring <- PSZ_cont_snotel %>%
  mutate(date = as.POSIXct(date, format = "%Y-%m-%d"),yday = yday(date), year = year(date)) %>%
  mutate(newsnow = ifelse(snow_water_equivalent>lag(snow_water_equivalent), snow_water_equivalent-lag(snow_water_equivalent), 0)) %>%
  filter(state != "SD", year >= 1979, ifelse(leap_year(year) == FALSE, yday >= 60 & yday <= 243, yday >= 61 & yday <= 244))

# SNOTEL Analysis, calculate the number and amount of positive SWE between 
cont_snotel_spring <- cont_snow_data %>%
  mutate(date = as.POSIXct(date, format = "%Y-%m-%d"),yday = yday(date), year = year(date)) %>%
  mutate(newsnow = ifelse(snow_water_equivalent>lag(snow_water_equivalent), snow_water_equivalent-lag(snow_water_equivalent), 0)) %>%
  filter(state != "SD", year >= 1979, ifelse(leap_year(year) == FALSE, yday >= 60 & yday <= 243, yday >= 61 & yday <= 244))

# PSZ determine average number of days with increased SWE per spring at each site
PSZ_cont_snotel_site <- PSZ_cont_snotel_spring %>%
  group_by(site_id, site_name, state, latitude, longitude, elev) %>%
  summarise(newsnow_days = sum(newsnow>0, na.rm = TRUE), years = length(unique(year)), avg_spring_days = newsnow_days/years, 
            newsnow_depth = sum(newsnow, na.rm = TRUE), avg_spring_snow = newsnow_depth/years)

# Determine average number of days with increased SWE per spring at each site
cont_snotel_site <- cont_snotel_spring %>%
  group_by(site_id, site_name, state, latitude, longitude, elev) %>%
  summarise(newsnow_days = sum(newsnow>0, na.rm = TRUE), years = length(unique(year)), avg_spring_days = newsnow_days/years, 
            newsnow_depth = sum(newsnow, na.rm = TRUE), avg_spring_snow = newsnow_depth/years)

# View data
mapview(cont_snotel_site, ycol = "latitude", xcol = "longitude", zcol = "avg_spring_days",
        layer.name = "AVG Sping Days (All Sites)" ,crs = 4326, grid = FALSE) + 
  mapview(PSZ_cont_snotel_site, ycol = "latitude", xcol = "longitude", zcol = "avg_spring_days",
        layer.name = "AVG Sping Days (PSZ Sites)" , crs = 4326, grid = FALSE)
```

```{r, fig.width=12,fig.height=7}
# Days of new snow at SNOTEL Sites in Western US
#Summarize the number of new SWE days and SWE depth at all sites per year
cont_snotel_site_yr <- cont_snotel_spring %>%
  group_by(site_id, site_name, state, year, latitude, longitude, elev) %>%
  summarise(newsnow_days = sum(newsnow>0, na.rm = TRUE), newsnow_depth = sum(newsnow, na.rm = TRUE))

# Create a box plot for all sites
spring_snow_days <- ggplot(cont_snotel_site_yr, aes(x = state, y= newsnow_days, color = state)) +
  geom_boxplot()+
  ggtitle("Days of increased SWE at all sites (1978-2022)")
ggplotly(spring_snow_days)

#Summarize the number of new SWE days and SWE depth at PSZ sites per year
PSZ_cont_snotel_site_yr <- PSZ_cont_snotel_spring %>%
  group_by(site_id, site_name, state, year, latitude, longitude, elev) %>%
  summarise(newsnow_days = sum(newsnow>0, na.rm = TRUE), newsnow_depth = sum(newsnow, na.rm = TRUE))

# Create a boxplot for all sites
PSZ_spring_snow_days <- ggplot(PSZ_cont_snotel_site_yr, aes(x = state, y= newsnow_days, color = state)) +
  geom_boxplot()+
  ggtitle("Days of increased SWE at PSZ sites (1978-2022)")
ggplotly(PSZ_spring_snow_days)
```

```{r}
summary(cont_snotel_site_yr$elev)
hist(cont_snotel_site_yr$elev)

cont_snotel_site_yr <- cont_snotel_site_yr %>% 
  mutate(elev_band = ifelse(elev >= 2000, "High (>=2500)", 
                            ifelse(elev < 2000 & elev >= 1200, "Mid (1500-2500)", "Low (<= 1500)")))
```

```{r}
# Elevation vs new snow count
elev_newsnow <- plot_ly(cont_snotel_site, x = ~avg_spring_days, y = ~elev, color = ~state, type = 'scatter', mode = 'markers', 
                        hoverinfo = 'text',
                        text = ~paste('</br> avg_new_days: ', avg_spring_days,
                                      '</br> elev: ', elev,
                                      '</br> site_name: ', site_name,
                                      '</br> state: ', state)) %>% 
  layout(title = "Average Increased SWE Days by Elevation")
 
elev_newsnow

elev_newsnow_depth <- plot_ly(cont_snotel_site, x = ~avg_spring_snow, y = ~elev, color = ~state, type = 'scatter', mode = 'markers', 
                        hoverinfo = 'text',
                        text = ~paste('</br> avg_new_snow: ', avg_spring_snow,
                                      '</br> elev: ', elev,
                                      '</br> site_name: ', site_name,
                                      '</br> state: ', state)) %>% 
  layout(title = "Average Increased SWE Days by Elevation")
 
elev_newsnow_depth

elev_boxplot <- ggplot(cont_snotel_site_yr, aes(x = elev_band, y= newsnow_days, color = elev_band)) +
  geom_boxplot()+
  ggtitle("New Snow Events by Elevation")
ggplotly(elev_boxplot)
```


```{r, fig.width=12,fig.height=7}
# Spring Snow depth
spring_snow_depth <- ggplot(cont_snotel_site_yr, aes(x = state, y= newsnow_depth, color = state)) +
  geom_boxplot()+
  ggtitle("Avg Depth of increased SWE at all sites (1978-2022)")
ggplotly(spring_snow_depth)

# Spring Snow depth
PSZ_spring_snow_depth <- ggplot(PSZ_cont_snotel_site_yr, aes(x = state, y= newsnow_depth, color = state)) +
  geom_boxplot()+
  ggtitle("Depth of increased SWE at PSZ sites (1978-2022)")
ggplotly(PSZ_spring_snow_depth)


# spring_snow_days_yr <- ggplot(cont_snotel_site_yr, aes(x = year, y = newsnow_days, group = state, color = state)) + 
#   geom_line()
# 
# ggplotly(spring_snow_days_yr)
```




```{r, echo=FALSE, eval=FALSE}
# Testing things
test_snow_data <- snotel_test %>%
  mutate(date = as.POSIXct(date, format = "%Y-%m-%d"),yday = yday(date), year = year(date))

test_spring <- test_snow_data %>%
  filter(ifelse(leap_year(year) == FALSE, yday >= 60 & yday <= 243, yday >= 61 & yday <= 244)) %>%
  mutate(newsnow = ifelse(snow_water_equivalent>lag(snow_water_equivalent), snow_water_equivalent-lag(snow_water_equivalent), 0))

site_stats <- test_spring %>%
  group_by(site_id, site_name, state, county, latitude, longitude, year) %>%
  summarise(day_SN = sum(newsnow>0, na.rm = TRUE))

ggplot(site_stats) +
  geom_line(aes(x = year, y= day_SN, color = site_name))

state_year_plot <- ggplot(cont_snotel_site_yr, aes(x = year, y = newsnow_days, group = state, color = state)) +
  geom_line()

ggplotly(state_year_plot)

site_year_plot <- cont_snotel_site_yr %>% group_by(site_id) %>% do(plots=ggplot(data=.) +
         aes(x=year, y=newsnow_days) + geom_line() + ggtitle(unique(.$site_name)))

site_year_plot[[2]]
```

